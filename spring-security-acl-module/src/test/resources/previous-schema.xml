<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2014 the original author or authors
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<!-- Installs the Spring security ACL schema -->

	<changeSet id="201408191330" author="arne" runAlways="true" dbms="oracle">
		<sql>
			ALTER session SET nls_length_semantics=CHAR;
		</sql>
	</changeSet>

	<!-- HSQLDB -->
	<changeSet id="201408191339" author="arne" dbms="hsqldb">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="acl_sid"/>
			</not>
		</preConditions>
		<comment>Creating ACL tables on HSQLDB</comment>
		<sql>
			create table acl_sid(
			id bigint generated by default as identity(start with 100) not null primary key,
			principal boolean not null,
			sid varchar_ignorecase(100) not null,
			constraint unique_uk_1 unique(sid,principal)
			);

			create table acl_class(
			id bigint generated by default as identity(start with 100) not null primary key,
			class varchar_ignorecase(100) not null,
			constraint unique_uk_2 unique(class)
			);

			create table acl_object_identity(
			id bigint generated by default as identity(start with 100) not null primary key,
			object_id_class bigint not null,
			object_id_identity bigint not null,
			parent_object bigint,
			owner_sid bigint,
			entries_inheriting boolean not null,
			constraint unique_uk_3 unique(object_id_class,object_id_identity),
			constraint foreign_fk_1 foreign key(parent_object)references acl_object_identity(id),
			constraint foreign_fk_2 foreign key(object_id_class)references acl_class(id),
			constraint foreign_fk_3 foreign key(owner_sid)references acl_sid(id)
			);

			create table acl_entry(
			id bigint generated by default as identity(start with 100) not null primary key,
			acl_object_identity bigint not null,
			ace_order int not null,
			sid bigint not null,
			mask integer not null,
			granting boolean not null,
			audit_success boolean not null,
			audit_failure boolean not null,
			constraint unique_uk_4 unique(acl_object_identity,ace_order),
			constraint foreign_fk_4 foreign key(acl_object_identity) references acl_object_identity(id),
			constraint foreign_fk_5 foreign key(sid) references acl_sid(id)
			);
		</sql>
	</changeSet>

	<!-- H2 -->
	<changeSet id="201708301208" author="arne" dbms="h2">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="acl_sid"/>
			</not>
		</preConditions>
		<comment>Creating ACL tables on HSQLDB</comment>
		<sql>
			create table acl_sid(
			id bigint generated by default as identity(start with 100) not null primary key,
			principal boolean not null,
			sid varchar_ignorecase(100) not null,
			constraint unique_uk_1 unique(sid,principal)
			);

			create table acl_class(
			id bigint generated by default as identity(start with 100) not null primary key,
			class varchar_ignorecase(100) not null,
			constraint unique_uk_2 unique(class)
			);

			create table acl_object_identity(
			id bigint generated by default as identity(start with 100) not null primary key,
			object_id_class bigint not null,
			object_id_identity bigint not null,
			parent_object bigint,
			owner_sid bigint,
			entries_inheriting boolean not null,
			constraint unique_uk_3 unique(object_id_class,object_id_identity),
			constraint foreign_fk_1 foreign key(parent_object)references acl_object_identity(id),
			constraint foreign_fk_2 foreign key(object_id_class)references acl_class(id),
			constraint foreign_fk_3 foreign key(owner_sid)references acl_sid(id)
			);

			create table acl_entry(
			id bigint generated by default as identity(start with 100) not null primary key,
			acl_object_identity bigint not null,
			ace_order int not null,
			sid bigint not null,
			mask integer not null,
			granting boolean not null,
			audit_success boolean not null,
			audit_failure boolean not null,
			constraint unique_uk_4 unique(acl_object_identity,ace_order),
			constraint foreign_fk_4 foreign key(acl_object_identity) references acl_object_identity(id),
			constraint foreign_fk_5 foreign key(sid) references acl_sid(id)
			);
		</sql>
	</changeSet>

	<!-- Mysql -->
	<changeSet id="201408191337" author="arne" dbms="mysql">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="acl_sid"/>
			</not>
		</preConditions>
		<comment>Creating ACL tables on MySQL</comment>
		<sql>
			CREATE TABLE acl_sid (
			id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
			principal BOOLEAN NOT NULL,
			sid VARCHAR(100) NOT NULL,
			UNIQUE KEY unique_acl_sid (sid, principal)
			) ENGINE=InnoDB;

			CREATE TABLE acl_class (
			id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
			class VARCHAR(100) NOT NULL,
			UNIQUE KEY uk_acl_class (class)
			) ENGINE=InnoDB;

			CREATE TABLE acl_object_identity (
			id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
			object_id_class BIGINT UNSIGNED NOT NULL,
			object_id_identity BIGINT NOT NULL,
			parent_object BIGINT UNSIGNED,
			owner_sid BIGINT UNSIGNED,
			entries_inheriting BOOLEAN NOT NULL,
			UNIQUE KEY uk_acl_object_identity (object_id_class, object_id_identity),
			CONSTRAINT fk_acl_object_identity_parent FOREIGN KEY (parent_object) REFERENCES acl_object_identity (id),
			CONSTRAINT fk_acl_object_identity_class FOREIGN KEY (object_id_class) REFERENCES acl_class (id),
			CONSTRAINT fk_acl_object_identity_owner FOREIGN KEY (owner_sid) REFERENCES acl_sid (id)
			) ENGINE=InnoDB;

			CREATE TABLE acl_entry (
			id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
			acl_object_identity BIGINT UNSIGNED NOT NULL,
			ace_order INTEGER NOT NULL,
			sid BIGINT UNSIGNED NOT NULL,
			mask INTEGER UNSIGNED NOT NULL,
			granting BOOLEAN NOT NULL,
			audit_success BOOLEAN NOT NULL,
			audit_failure BOOLEAN NOT NULL,
			UNIQUE KEY unique_acl_entry (acl_object_identity, ace_order),
			CONSTRAINT fk_acl_entry_object FOREIGN KEY (acl_object_identity) REFERENCES acl_object_identity (id),
			CONSTRAINT fk_acl_entry_acl FOREIGN KEY (sid) REFERENCES acl_sid (id)
			) ENGINE=InnoDB;
		</sql>
	</changeSet>

	<!-- Oracle -->
	<changeSet id="201408191345" author="arne" dbms="oracle">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="acl_sid"/>
			</not>
		</preConditions>
		<comment>Creating ACL tables on Oracle</comment>
		<sql>
			CREATE TABLE acl_sid (
			id NUMBER(38) NOT NULL PRIMARY KEY,
			principal NUMBER(1) NOT NULL CHECK (principal in (0, 1)),
			sid NVARCHAR2(100) NOT NULL,
			CONSTRAINT unique_acl_sid UNIQUE (sid, principal)
			);
			CREATE SEQUENCE acl_sid_sequence START WITH 1 INCREMENT BY 1 NOMAXVALUE;
		</sql>
		<sql splitStatements="false">
			CREATE OR REPLACE TRIGGER acl_sid_id_trigger
			BEFORE INSERT ON acl_sid
			FOR EACH ROW
			BEGIN
			SELECT acl_sid_sequence.nextval INTO :new.id FROM dual;
			END;
		</sql>
		<sql>
			CREATE TABLE acl_class (
			id NUMBER(38) NOT NULL PRIMARY KEY,
			class NVARCHAR2(100) NOT NULL,
			CONSTRAINT uk_acl_class UNIQUE (class)
			);
			CREATE SEQUENCE acl_class_sequence START WITH 1 INCREMENT BY 1 NOMAXVALUE;
		</sql>
		<sql splitStatements="false">
			CREATE OR REPLACE TRIGGER acl_class_id_trigger
			BEFORE INSERT ON acl_class
			FOR EACH ROW
			BEGIN
			SELECT acl_class_sequence.nextval INTO :new.id FROM dual;
			END;
		</sql>
		<sql>
			CREATE TABLE acl_object_identity (
			id NUMBER(38) NOT NULL PRIMARY KEY,
			object_id_class NUMBER(38) NOT NULL,
			object_id_identity NUMBER(38) NOT NULL,
			parent_object NUMBER(38),
			owner_sid NUMBER(38),
			entries_inheriting NUMBER(1) NOT NULL CHECK (entries_inheriting in (0, 1)),
			CONSTRAINT uk_acl_object_identity UNIQUE (object_id_class, object_id_identity),
			CONSTRAINT fk_acl_object_identity_parent FOREIGN KEY (parent_object) REFERENCES acl_object_identity (id),
			CONSTRAINT fk_acl_object_identity_class FOREIGN KEY (object_id_class) REFERENCES acl_class (id),
			CONSTRAINT fk_acl_object_identity_owner FOREIGN KEY (owner_sid) REFERENCES acl_sid (id)
			);
			CREATE SEQUENCE acl_object_identity_sequence START WITH 1 INCREMENT BY 1 NOMAXVALUE;
		</sql>
		<sql splitStatements="false">
			CREATE OR REPLACE TRIGGER acl_object_identity_id_trigger
			BEFORE INSERT ON acl_object_identity
			FOR EACH ROW
			BEGIN
			SELECT acl_object_identity_sequence.nextval INTO :new.id FROM dual;
			END;
		</sql>
		<sql>
			CREATE TABLE acl_entry (
			id NUMBER(38) NOT NULL PRIMARY KEY,
			acl_object_identity NUMBER(38) NOT NULL,
			ace_order INTEGER NOT NULL,
			sid NUMBER(38) NOT NULL,
			mask INTEGER NOT NULL,
			granting NUMBER(1) NOT NULL CHECK (granting in (0, 1)),
			audit_success NUMBER(1) NOT NULL CHECK (audit_success in (0, 1)),
			audit_failure NUMBER(1) NOT NULL CHECK (audit_failure in (0, 1)),
			CONSTRAINT unique_acl_entry UNIQUE (acl_object_identity, ace_order),
			CONSTRAINT fk_acl_entry_object FOREIGN KEY (acl_object_identity) REFERENCES acl_object_identity (id),
			CONSTRAINT fk_acl_entry_acl FOREIGN KEY (sid) REFERENCES acl_sid (id)
			);
			CREATE SEQUENCE acl_entry_sequence START WITH 1 INCREMENT BY 1 NOMAXVALUE;
		</sql>
		<sql splitStatements="false">
			CREATE OR REPLACE TRIGGER acl_entry_id_trigger
			BEFORE INSERT ON acl_entry
			FOR EACH ROW
			BEGIN
			SELECT acl_entry_sequence.nextval INTO :new.id FROM dual;
			END;
		</sql>
	</changeSet>

	<!-- SQL Server -->
	<changeSet id="201408191414" author="arne" dbms="mssql">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="acl_sid"/>
			</not>
		</preConditions>
		<comment>Creating ACL tables on SQL Server</comment>
		<sql>
			CREATE TABLE acl_sid (
			id BIGINT NOT NULL IDENTITY PRIMARY KEY,
			principal BIT NOT NULL,
			sid VARCHAR(100) NOT NULL,
			CONSTRAINT unique_acl_sid UNIQUE (sid, principal)
			);

			CREATE TABLE acl_class (
			id BIGINT NOT NULL IDENTITY PRIMARY KEY,
			class VARCHAR(100) NOT NULL,
			CONSTRAINT uk_acl_class UNIQUE (class)
			);

			CREATE TABLE acl_object_identity (
			id BIGINT NOT NULL IDENTITY PRIMARY KEY,
			object_id_class BIGINT NOT NULL,
			object_id_identity BIGINT NOT NULL,
			parent_object BIGINT,
			owner_sid BIGINT,
			entries_inheriting BIT NOT NULL,
			CONSTRAINT uk_acl_object_identity UNIQUE (object_id_class, object_id_identity),
			CONSTRAINT fk_acl_object_identity_parent FOREIGN KEY (parent_object) REFERENCES acl_object_identity (id),
			CONSTRAINT fk_acl_object_identity_class FOREIGN KEY (object_id_class) REFERENCES acl_class (id),
			CONSTRAINT fk_acl_object_identity_owner FOREIGN KEY (owner_sid) REFERENCES acl_sid (id)
			);

			CREATE TABLE acl_entry (
			id BIGINT NOT NULL IDENTITY PRIMARY KEY,
			acl_object_identity BIGINT NOT NULL,
			ace_order INTEGER NOT NULL,
			sid BIGINT NOT NULL,
			mask INTEGER NOT NULL,
			granting BIT NOT NULL,
			audit_success BIT NOT NULL,
			audit_failure BIT NOT NULL,
			CONSTRAINT unique_acl_entry UNIQUE (acl_object_identity, ace_order),
			CONSTRAINT fk_acl_entry_object FOREIGN KEY (acl_object_identity) REFERENCES acl_object_identity (id),
			CONSTRAINT fk_acl_entry_acl FOREIGN KEY (sid) REFERENCES acl_sid (id)
			);
		</sql>
	</changeSet>

	<changeSet id="201901301433" author="marc" dbms="postgresql">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="acl_sid"/>
			</not>
		</preConditions>
		<comment>Creating ACL tables on Postgres</comment>
		<sql>
			create table acl_sid(
			id bigserial not null primary key,
			principal boolean not null,
			sid varchar(100) not null,
			constraint unique_uk_1 unique(sid,principal)
			);

			create table acl_class(
			id bigserial not null primary key,
			class varchar(100) not null,
			constraint unique_uk_2 unique(class)
			);

			create table acl_object_identity(
			id bigserial primary key,
			object_id_class bigint not null,
			object_id_identity bigint not null,
			parent_object bigint,
			owner_sid bigint,
			entries_inheriting boolean not null,
			constraint unique_uk_3 unique(object_id_class,object_id_identity),
			constraint foreign_fk_1 foreign key(parent_object)references acl_object_identity(id),
			constraint foreign_fk_2 foreign key(object_id_class)references acl_class(id),
			constraint foreign_fk_3 foreign key(owner_sid)references acl_sid(id)
			);

			create table acl_entry(
			id bigserial primary key,
			acl_object_identity bigint not null,
			ace_order int not null,
			sid bigint not null,
			mask integer not null,
			granting boolean not null,
			audit_success boolean not null,
			audit_failure boolean not null,
			constraint unique_uk_4 unique(acl_object_identity,ace_order),
			constraint foreign_fk_4 foreign key(acl_object_identity) references acl_object_identity(id),
			constraint foreign_fk_5 foreign key(sid) references acl_sid(id)
			);
		</sql>
	</changeSet>

	<changeSet id="201408281312" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="acl_entity"/>
			</not>
		</preConditions>

		<comment>Create acl_entity table</comment>

		<createTable tableName="acl_entity">
			<column name="id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_acl_entity"/>
			</column>
			<column name="name" type="java.sql.Types.VARCHAR(100)">
				<constraints nullable="false" unique="true"/>
			</column>
			<column name="parent_id" type="java.sql.Types.BIGINT">
				<constraints nullable="true" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="20150828" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<indexExists tableName="acl_entity" columnNames="name" />
			</not>
		</preConditions>

		<comment>Add index on acl security entity name</comment>

		<createIndex tableName="acl_entity" indexName="ix_acl_entity_name" unique="true">
			<column name="name" />
		</createIndex>
	</changeSet>
	
	<!-- Install pre-existing test data -->
	<changeSet id="201907281035" author="arne" dbms="h2, hsqldb, mssql, postgresql">
		<insert tableName="acl_sid">
			<column name="id">32</column>
			<column name="principal">true</column>
			<column name="sid">system</column>
		</insert>
		<insert tableName="acl_sid">
			<column name="id">33</column>
			<column name="principal">true</column>
			<column name="sid">john</column>
		</insert>
		<insert tableName="acl_class">
			<column name="id">34</column>
			<column name="class">my.domain.SomeObject</column>
		</insert>
		<insert tableName="acl_object_identity">
			<column name="id">35</column>
			<column name="object_id_class">34</column>
			<column name="object_id_identity">123</column>
			<column name="owner_sid">32</column>
			<column name="entries_inheriting">false</column>
		</insert>
		<insert tableName="acl_entry">
			<column name="id">36</column>
			<column name="acl_object_identity">35</column>
			<column name="ace_order">1</column>
			<column name="sid">33</column>
			<column name="mask">1</column>
			<column name="granting">true</column>
			<column name="audit_success">false</column>
			<column name="audit_failure">false</column>
		</insert>
	</changeSet>

	<changeSet id="201907281036" author="arne" dbms="mysql, oracle">
		<insert tableName="acl_sid">
			<column name="id">1</column>
			<column name="principal">1</column>
			<column name="sid">system</column>
		</insert>
		<insert tableName="acl_sid">
			<column name="id">2</column>
			<column name="principal">1</column>
			<column name="sid">john</column>
		</insert>
		<insert tableName="acl_class">
			<column name="id">1</column>
			<column name="class">my.domain.SomeObject</column>
		</insert>
		<insert tableName="acl_object_identity">
			<column name="id">1</column>
			<column name="object_id_class">1</column>
			<column name="object_id_identity">123</column>
			<column name="owner_sid">1</column>
			<column name="entries_inheriting">0</column>
		</insert>
		<insert tableName="acl_entry">
			<column name="id">1</column>
			<column name="acl_object_identity">1</column>
			<column name="ace_order">1</column>
			<column name="sid">2</column>
			<column name="mask">1</column>
			<column name="granting">1</column>
			<column name="audit_success">0</column>
			<column name="audit_failure">0</column>
		</insert>
	</changeSet>
</databaseChangeLog>
